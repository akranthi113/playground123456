<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vedic Astrology South Indian Chart</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            background-color: #121212; /* Dark background */
            margin: 0;
            padding: 20px;
            color: #e0e0e0; /* Light text */
        }

        .chart-title {
            text-align: center;
            font-size: 1.7em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #bdbdbd; /* Lighter title */
        }

        .chart-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 85px);
            gap: 1px;
            width: 360px;
            height: 360px;
            margin: auto;
            border: 1px solid #444; /* Light border */
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.4);
        }

        .chart-box {
            border: 1px solid #333; /* Darker inner borders */
            position: relative;
            background-color: #242424; /* Dark box background */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            padding: 3px;
            overflow: hidden;
        }

        .sign-label {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 0.7em;
            color: #aaa; /* Faded light color */
            font-weight: normal;
        }

        .house-label {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 0.75em;
            color: #64b5f6; /* Blue for house numbers */
            font-weight: bold;
        }

        .planet {
            cursor: grab; /* Default cursor for drag */
            margin: 1px;
            font-size: 0.8em;
            padding: 2px 4px;
            border-radius: 3px;
            display: flex;
            flex-direction: column; /* To stack the symbol and degree */
            align-items: center;
            white-space: nowrap;
            user-select: none;
            transition: background-color 0.2s, opacity 0.2s, transform 0.1s;
            box-shadow: 0.5px 0.5px 2px rgba(255,255,255,0.1); /* Subtle white shadow */
            position: relative;
            color: #121212; /* Black text for contrast */
        }

        .planet-symbol {
            font-weight: bold;
            font-size: 1em;
        }

        .planet-degree-display { /* This will only show degree now */
            font-size: 0.7em;
            color: #121212;
            margin-top: 1px;
        }

        .Lagna {
            background-color: #e0e0e0;
            color: #121212;
            font-weight: bold;
        }

        .planet:hover {
            transform: translateY(-1px);
        }

        .planet:active {
            cursor: grabbing;
        }

        /* Planet specific colors */
        .Sun { background-color: #ffd700; } /* Gold */
        .Moon { background-color: #e0e0e0; } /* Light Gray */
        .Mars { background-color: #ff5252; } /* Red */
        .Mercury { background-color: #00e676; } /* Green */
        .Jupiter { background-color: #ffb300; } /* Amber */
        .Venus { background-color: #e91e63; } /* Pink */
        .Saturn { background-color: #7986cb; } /* Indigo */
        .Rahu { background-color: #9e9e9e; } /* Gray */
        .Ketu { background-color: #616161; } /* Dark Gray */

        .planets-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            min-height: 20px;
            margin-top: 12px;
            padding-top: 3px;
        }

        .planets-container.drag-over {
            background-color: #1f3a5f; /* Dark blue highlight */
            border: 1px dashed #64b5f6;
        }

        .controls {
            text-align: center;
            margin-top: 25px;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background-color: #1e1e1e;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 1px 1px 8px rgba(0, 0, 0, 0.4);
        }

        .controls div {
            margin-bottom: 10px;
        }

        .controls label,
        .controls span {
            font-weight: 500;
            margin-right: 8px;
        }

        button {
            padding: 7px 14px;
            font-size: 0.95em;
            margin: 4px;
            border-radius: 4px;
            border: 1px solid #64b5f6;
            background-color: transparent;
            color: #64b5f6;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        button:hover {
            background-color: #64b5f6;
            color: #121212;
        }

        button.secondary {
            border-color: #aaa;
            color: #aaa;
        }

        button.secondary:hover {
            background-color: #aaa;
            color: #121212;
        }

        #planet-bank {
            border: 1px dashed #444;
            padding: 8px;
            min-height: 35px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            margin-top: 8px;
            background-color: #1e1e1e;
        }

        /* Styles for the tooltip */
        .planet-tooltip {
            position: fixed;
            background-color: #333; /* Dark background for tooltip */
            color: #fff; /* White text */
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none; /* Make it transparent to mouse events */
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .planet-tooltip.active {
            opacity: 1;
        }

        /* Styles for the Retrograde Panel */
        #retrograde-panel {
            position: fixed;
            background-color: #2a2a2a;
            border: 1px solid #64b5f6;
            border-radius: 5px;
            padding: 10px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 101; /* Higher than tooltip */
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 8px;
        }
        #retrograde-panel.active {
            display: flex;
        }
        #retrograde-panel label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #e0e0e0;
            font-size: 0.9em;
        }
        #retrograde-panel input[type="checkbox"] {
            transform: scale(1.2); /* Make checkbox slightly larger */
            cursor: pointer;
        }
        #retrograde-panel .panel-planet-name {
            font-weight: bold;
            color: #ffcc80;
            font-size: 1.1em;
        }

        /* Style for retrograde symbol (R) next to planet symbol */
        .planet.retrograde .retrograde-symbol {
            font-size: 0.9em;
            color: #ff5252; /* Red for retrograde */
            font-weight: bold;
            margin-left: 2px;
            vertical-align: super; /* Position slightly above */
        }
    </style>
</head>
<body>
    <div class="chart-title">Interactive South Indian Vedic Astrology Chart</div>

    <div class="chart-container" id="chart-container">
        <div class="chart-box" data-sign="Pisces">
            <div class="sign-label">Pi</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Pisces"></div>
        </div>
        <div class="chart-box" data-sign="Aries">
            <div class="sign-label">Ar</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Aries"></div>
        </div>
        <div class="chart-box" data-sign="Taurus">
            <div class="sign-label">Ta</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Taurus"></div>
        </div>
        <div class="chart-box" data-sign="Gemini">
            <div class="sign-label">Ge</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Gemini"></div>
        </div>
        <div class="chart-box" data-sign="Aquarius">
            <div class="sign-label">Aq</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Aquarius"></div>
        </div>
        <div class="chart-box empty-box"></div>
        <div class="chart-box empty-box"></div>
        <div class="chart-box" data-sign="Cancer">
            <div class="sign-label">Cn</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Cancer"></div>
        </div>
        <div class="chart-box" data-sign="Capricorn">
            <div class="sign-label">Cp</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Capricorn"></div>
        </div>
        <div class="chart-box empty-box"></div>
        <div class="chart-box empty-box"></div>
        <div class="chart-box" data-sign="Leo">
            <div class="sign-label">Le</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Leo"></div>
        </div>
        <div class="chart-box" data-sign="Sagittarius">
            <div class="sign-label">Sg</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Sagittarius"></div>
        </div>
        <div class="chart-box" data-sign="Scorpio">
            <div class="sign-label">Sc</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Scorpio"></div>
        </div>
        <div class="chart-box" data-sign="Libra">
            <div class="sign-label">Li</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Libra"></div>
        </div>
        <div class="chart-box" data-sign="Virgo">
            <div class="sign-label">Vi</div>
            <div class="house-label"></div>
            <div class="planets-container" data-sign="Virgo"></div>
        </div>
    </div>

    <div class="controls">
        <div>
            <span>Drag Planets to Chart (Double-click or drag to bank to remove):</span>
            <div id="planet-bank">
                <span class="planet Lagna" draggable="true" id="Lagna"><span class="planet-symbol">L</span></span>
                <span class="planet Sun" draggable="true" id="Sun"><span class="planet-symbol">Su</span></span>
                <span class="planet Moon" draggable="true" id="Moon"><span class="planet-symbol">Mo</span></span>
                <span class="planet Mars" draggable="true" id="Mars"><span class="planet-symbol">Ma</span></span>
                <span class="planet Mercury" draggable="true" id="Mercury"><span class="planet-symbol">Me</span></span>
                <span class="planet Jupiter" draggable="true" id="Jupiter"><span class="planet-symbol">Ju</span></span>
                <span class="planet Venus" draggable="true" id="Venus"><span class="planet-symbol">Ve</span></span>
                <span class="planet Saturn" draggable="true" id="Saturn"><span class="planet-symbol">Sa</span></span>
                <span class="planet Rahu" draggable="true" id="Rahu"><span class="planet-symbol">Ra</span></span>
                <span class="planet Ketu" draggable="true" id="Ketu"><span class="planet-symbol">Ke</span></span>
            </div>
        </div>
        <button onclick="resetChart()">Clear Chart</button>
        <p>Tip: Click and drag a planet in the chart up or down to adjust its degree.</p>
    </div>

    <div id="planet-tooltip" class="planet-tooltip"></div>

    <div id="retrograde-panel">
        <div class="panel-planet-name"></div>
        <label>
            <input type="checkbox" id="retrograde-checkbox"> Retrograde
        </label>
    </div>

    <script>
        const signs = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"];

        const nakshatras = [
            { name: 'Ashwini', range: '0° – 13°20′ Aries', ruler: 'Ketu', symbol: 'Horse Head', deity: 'Ashwini Kumaras' },
            { name: 'Bharani', range: '13°20′ – 26°40′ Aries', ruler: 'Venus', symbol: 'Yoni', deity: 'Yama' },
            { name: 'Krittika', range: '26°40′ Aries – 10° Taurus', ruler: 'Sun', symbol: 'Razor/Axe', deity: 'Agni' },
            { name: 'Rohini', range: '10° – 23°20′ Taurus', ruler: 'Moon', symbol: 'Cart/Chariot', deity: 'Brahma' },
            { name: 'Mrigashira', range: '23°20′ Taurus – 6°40′ Gemini', ruler: 'Mars', symbol: 'Deer Head', deity: 'Soma (Moon)' },
            { name: 'Ardra', range: '6°40′ – 20° Gemini', ruler: 'Rahu', symbol: 'Teardrop/Diamond', deity: 'Rudra (Shiva)' },
            { name: 'Punarvasu', range: '20° Gemini – 3°20′ Cancer', ruler: 'Jupiter', symbol: 'Quiver of Arrows', deity: 'Aditi' },
            { name: 'Pushya', range: '3°20′ – 16°40′ Cancer', ruler: 'Saturn', symbol: 'Cow Udder', deity: 'Brihaspati (Jupiter)' },
            { name: 'Ashlesha', range: '16°40′ – 30° Cancer', ruler: 'Mercury', symbol: 'Coiled Serpent', deity: 'Nagas (Serpents)' },
            { name: 'Magha', range: '0° – 13°20′ Leo', ruler: 'Ketu', symbol: 'Royal Throne', deity: 'Pitri (Ancestors)' },
            { name: 'Purva Phalguni', range: '13°20′ – 26°40′ Leo', ruler: 'Venus', symbol: 'Front Legs of Bed', deity: 'Bhaga (God of Wealth)' },
            { name: 'Uttara Phalguni', range: '26°40′ Leo – 10° Virgo', ruler: 'Sun', symbol: 'Back Legs of Bed', deity: 'Aryaman' },
            { name: 'Hasta', range: '10° – 23°20′ Virgo', ruler: 'Moon', symbol: 'Hand', deity: 'Savitar (Sun God)' },
            { name: 'Chitra', range: '23°20′ Virgo – 6°40′ Libra', ruler: 'Mars', symbol: 'Pearl', deity: 'Vishwakarma' },
            { name: 'Swati', range: '6°40′ – 20° Libra', ruler: 'Rahu', symbol: 'Coral/Sword', deity: 'Vayu (Wind God)' },
            { name: 'Vishakha', range: '20° Libra – 3°20′ Scorpio', ruler: 'Jupiter', symbol: 'Triumphal Arch', deity: 'Indragni' },
            { name: 'Anuradha', range: '3°20′ – 16°40′ Scorpio', ruler: 'Saturn', symbol: 'Lotus', deity: 'Mitra (Sun God)' },
            { name: 'Jyeshtha', range: '16°40′ – 30° Scorpio', ruler: 'Mercury', symbol: 'Earring/Umbrella', deity: 'Indra' },
            { name: 'Moola', range: '0° – 13°20′ Sagittarius', ruler: 'Ketu', symbol: 'Root', deity: 'Nirriti (Goddess of Calamity)' },
            { name: 'Purva Ashadha', range: '13°20′ – 26°40′ Sagittarius', ruler: 'Venus', symbol: 'Elephant Tusk/Fan', deity: 'Apah (Water Goddess)' },
            { name: 'Uttara Ashadha', range: '26°40′ Sagittarius – 10° Capricorn', ruler: 'Sun', symbol: 'Elephant Tusk/Plank', deity: 'Vishvadevas' },
            { name: 'Shravana', range: '10° – 23°20′ Capricorn', ruler: 'Moon', symbol: 'Ear', deity: 'Vishnu' },
            { name: 'Dhanishta', range: '23°20′ Capricorn – 6°40′ Aquarius', ruler: 'Mars', symbol: 'Musical Drum', deity: 'Vasu (Gods of Light)' },
            { name: 'Shatabhisha', range: '6°40′ – 20° Aquarius', ruler: 'Rahu', symbol: '100 Physicians/Stars', deity: 'Varuna (God of Cosmic Law)' },
            { name: 'Purva Bhadrapada', range: '20° Aquarius – 3°20′ Pisces', ruler: 'Jupiter', symbol: 'Front Legs of Funeral Cot', deity: 'Aja Ekapad' },
            { name: 'Uttara Bhadrapada', range: '3°20′ – 16°40′ Pisces', ruler: 'Saturn', symbol: 'Back Legs of Funeral Cot', deity: 'Ahir Bhudhanya' },
            { name: 'Revati', range: '16°40′ – 30° Pisces', ruler: 'Mercury', symbol: 'Drum/Fish', deity: 'Pushan (Nourishment)' }
        ];

        let draggedPlanetId = null;
        const planetDegrees = {}; // Stores { sign: "...", degree: #, isRetrograde: boolean }
        let initialPlanetBankHTML = '';
        let lagnaSign = null;

        let isChangingDegree = false;
        let degreeChangePlanet = null;
        let initialMouseY = 0;
        let initialPlanetDegree = 0;

        const planetTooltip = document.getElementById('planet-tooltip');
        const retrogradePanel = document.getElementById('retrograde-panel');
        const retrogradeCheckbox = document.getElementById('retrograde-checkbox');
        const panelPlanetName = retrogradePanel.querySelector('.panel-planet-name');
        let selectedPlanetForRetrograde = null; // Stores the planet element being edited for retrograde

        document.addEventListener('DOMContentLoaded', () => {
            initialPlanetBankHTML = document.getElementById('planet-bank').innerHTML;
            attachDelegatedListeners();
            updateHouseNumbers();
        });
        
        function attachDelegatedListeners() {
            document.addEventListener('dragstart', handleDragStart);
            document.addEventListener('dragend', handleDragEnd);
            document.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mouseup', handleMouseUp);
            document.addEventListener('dblclick', handleDblClick);
            document.addEventListener('mousemove', handleMouseMoveForTooltip);

            document.querySelectorAll('.planets-container').forEach(container => {
                container.addEventListener('dragover', allowDrop);
                container.addEventListener('drop', dropToChart);
                container.addEventListener('dragleave', removeDragOverHighlight);
                container.addEventListener('mouseover', handleContainerMouseOver);
                container.addEventListener('mouseout', handleContainerMouseOut);
                container.addEventListener('click', handlePlanetClick); // New: for retrograde panel
            });

            const planetBank = document.getElementById('planet-bank');
            planetBank.addEventListener('dragover', allowDrop);
            planetBank.addEventListener('drop', dropToBank);
            planetBank.addEventListener('dragleave', removeDragOverHighlight);
            
            // Listener for the retrograde checkbox
            retrogradeCheckbox.addEventListener('change', toggleRetrograde);

            // Click anywhere outside the panel to close it
            document.addEventListener('click', handleOutsideClick);
        }

        // --- Drag & Drop Handlers ---
        
        function handleDragStart(e) {
            const planetElement = e.target.closest('.planet');
            if (planetElement) {
                draggedPlanetId = planetElement.id;
                e.dataTransfer.setData('text/plain', draggedPlanetId);
                planetElement.style.opacity = '0.5';
                hideTooltip();
                hideRetrogradePanel(); // Hide panel when dragging starts
            }
        }

        function handleDragEnd(e) {
            const planetElement = e.target.closest('.planet');
            if (planetElement) {
                planetElement.style.opacity = '1';
                draggedPlanetId = null;
            }
        }

        function allowDrop(e) {
            e.preventDefault();
            let targetElement = e.target.classList.contains('planets-container') || e.target.id === 'planet-bank' ? e.target : e.target.closest('.planets-container') || e.target.closest('#planet-bank');
            if (targetElement) {
                targetElement.classList.add('drag-over');
            }
        }

        function removeDragOverHighlight(e) {
            let targetElement = e.target.classList.contains('planets-container') || e.target.id === 'planet-bank' ? e.target : e.target.closest('.planets-container') || e.target.closest('#planet-bank');
            if (targetElement) {
                targetElement.classList.remove('drag-over');
            }
        }

        function dropToChart(e) {
            e.preventDefault();
            let targetContainer = e.target.classList.contains('planets-container') ? e.target : e.target.closest('.planets-container');

            if (!targetContainer || !draggedPlanetId) return;

            targetContainer.classList.remove('drag-over');
            hideTooltip();
            hideRetrogradePanel(); // Hide panel on drop

            const planetToMove = document.getElementById(draggedPlanetId);
            if (!planetToMove) return;

            const currentParent = planetToMove.parentElement;
            
            if (currentParent === targetContainer) return;

            if (draggedPlanetId === 'Lagna') {
                const existingLagna = document.querySelector('.planets-container .Lagna');
                if (existingLagna) {
                    const oldLagnaParent = existingLagna.parentElement;
                    const planetBank = document.getElementById('planet-bank');
                    
                    if (oldLagnaParent !== planetBank) {
                        oldLagnaParent.removeChild(existingLagna);
                        planetBank.appendChild(existingLagna);
                        delete planetDegrees[existingLagna.id];
                        updatePlanetDegreeDisplay(existingLagna);
                        updateRetrogradeSymbol(existingLagna); // Ensure symbol is removed
                    }
                }
                lagnaSign = targetContainer.dataset.sign;
                updateHouseNumbers();
            }
            
            if (currentParent && (currentParent.classList.contains('planets-container') || currentParent.id === 'planet-bank')) {
                currentParent.removeChild(planetToMove);
            }

            targetContainer.appendChild(planetToMove);
            
            const sign = targetContainer.dataset.sign;
            if (!planetDegrees[planetToMove.id]) {
                planetDegrees[planetToMove.id] = {
                    sign: sign,
                    degree: parseFloat((Math.random() * 30).toFixed(2)),
                    isRetrograde: false // Default to not retrograde
                };
            } else {
                planetDegrees[planetToMove.id].sign = sign;
            }
            updatePlanetDegreeDisplay(planetToMove);
            updateRetrogradeSymbol(planetToMove); // Update symbol on drop
        }

        function dropToBank(e) {
            e.preventDefault();
            let targetBank = e.target.id === 'planet-bank' ? e.target : e.target.closest('#planet-bank');

            if (!targetBank || !draggedPlanetId) return;

            targetBank.classList.remove('drag-over');
            hideTooltip();
            hideRetrogradePanel(); // Hide panel on drop

            const planetToMove = document.getElementById(draggedPlanetId);
            if (!planetToMove) return;
            
            if (planetToMove.parentElement.id !== 'planet-bank') {
                const currentParent = planetToMove.parentElement;
                if (currentParent && currentParent.classList.contains('planets-container')) {
                    currentParent.removeChild(planetToMove);
                }
                targetBank.appendChild(planetToMove);

                if (planetToMove.id === 'Lagna') {
                    lagnaSign = null;
                    updateHouseNumbers();
                }
                
                delete planetDegrees[planetToMove.id];
                updatePlanetDegreeDisplay(planetToMove);
                updateRetrogradeSymbol(planetToMove); // Ensure symbol is removed
            }
        }
        
        // --- Degree Change Handlers ---

        function handleMouseDown(e) {
            const planetElement = e.target.closest('.planet');
            if (!planetElement) return;

            if (planetElement.parentElement.classList.contains('planets-container')) {
                e.preventDefault(); // Prevent text selection and default drag behavior
                isChangingDegree = true;
                degreeChangePlanet = planetElement;
                initialMouseY = e.clientY;
                initialPlanetDegree = planetDegrees[planetElement.id]?.degree || 0;

                document.addEventListener('mousemove', handleDegreeChangeMouseMove);
                hideTooltip();
                hideRetrogradePanel(); // Hide panel when starting degree change
            }
        }

        function handleDegreeChangeMouseMove(e) {
            if (!isChangingDegree || !degreeChangePlanet) return;
            
            const deltaY = initialMouseY - e.clientY;
            const degreeChange = deltaY / 20; 
            let newDegree = initialPlanetDegree + degreeChange;

            newDegree = Math.max(0, Math.min(29.99, newDegree));

            if (planetDegrees[degreeChangePlanet.id]) {
                planetDegrees[degreeChangePlanet.id].degree = parseFloat(newDegree.toFixed(2));
                updatePlanetDegreeDisplay(degreeChangePlanet);
                showTooltip(degreeChangePlanet); // Keep tooltip updated during drag
            }
        }

        function handleMouseUp() {
            if (isChangingDegree) {
                isChangingDegree = false;
                degreeChangePlanet = null;
                document.removeEventListener('mousemove', handleDegreeChangeMouseMove);
            }
        }

        function handleDblClick(e) {
            const planetToRemove = e.target.closest('.planet');
            if (!planetToRemove) return;

            const currentContainer = planetToRemove.parentElement;

            if (currentContainer && currentContainer.classList.contains('planets-container')) {
                currentContainer.removeChild(planetToRemove);
                document.getElementById('planet-bank').appendChild(planetToRemove);
                
                if (planetToRemove.id === 'Lagna') {
                    lagnaSign = null;
                    updateHouseNumbers();
                }
                
                delete planetDegrees[planetToRemove.id];
                updatePlanetDegreeDisplay(planetToRemove);
                updateRetrogradeSymbol(planetToRemove); // Ensure symbol is removed
                hideTooltip();
                hideRetrogradePanel(); // Hide panel on double-click
            }
        }

        // --- Tooltip Functions ---

        function handleContainerMouseOver(e) {
            const planetElement = e.target.closest('.planet');
            if (planetElement && planetElement.parentElement.classList.contains('planets-container') && planetDegrees[planetElement.id]) {
                showTooltip(planetElement);
            }
        }

        function handleContainerMouseOut(e) {
            if (!isChangingDegree && !retrogradePanel.classList.contains('active')) {
                const relatedTarget = e.relatedTarget;
                if (!relatedTarget || (!relatedTarget.closest('.planet') && !relatedTarget.closest('#planet-tooltip') && !relatedTarget.closest('#retrograde-panel'))) {
                    hideTooltip();
                }
            }
        }

        function handleMouseMoveForTooltip(e) {
            if (planetTooltip.classList.contains('active') && !isChangingDegree) {
                const targetPlanet = e.target.closest('.planet');
                // Only keep tooltip if mouse is over the same planet that triggered it
                if (targetPlanet && planetDegrees[targetPlanet.id] && e.target.closest('.planet') === document.querySelector('.planet.hovered-for-tooltip')) {
                     showTooltip(targetPlanet);
                } else {
                     hideTooltip();
                }
            }
        }

        function showTooltip(planetElement) {
            // Add a class to the hovered planet to track it
            document.querySelectorAll('.planet.hovered-for-tooltip').forEach(el => el.classList.remove('hovered-for-tooltip'));
            planetElement.classList.add('hovered-for-tooltip');


            const planetData = planetDegrees[planetElement.id];
            if (!planetData) {
                hideTooltip();
                return;
            }

            const nakData = getNakshatraAndPada(planetData.sign, planetData.degree);
            
            let tooltipContent = `${planetData.degree.toFixed(2)}° ${planetData.sign} | ${nakData.nakshatra.name} – Pada ${nakData.pada}`;
            if (planetData.isRetrograde) {
                tooltipContent += " (Retrograde)";
            }
            planetTooltip.textContent = tooltipContent;
            
            const rect = planetElement.getBoundingClientRect();
            // Position above the planet
            planetTooltip.style.left = `${rect.left + (rect.width / 2) - (planetTooltip.offsetWidth / 2)}px`;
            planetTooltip.style.top = `${rect.top - planetTooltip.offsetHeight - 5}px`;

            if (parseFloat(planetTooltip.style.left) < 0) {
                planetTooltip.style.left = '5px';
            }
            if (parseFloat(planetTooltip.style.left) + planetTooltip.offsetWidth > window.innerWidth) {
                planetTooltip.style.left = `${window.innerWidth - planetTooltip.offsetWidth - 5}px`;
            }
            if (parseFloat(planetTooltip.style.top) < 0) {
                planetTooltip.style.top = `${rect.bottom + 5}px`;
            }

            planetTooltip.classList.add('active');
        }

        function hideTooltip() {
            planetTooltip.classList.remove('active');
            document.querySelectorAll('.planet.hovered-for-tooltip').forEach(el => el.classList.remove('hovered-for-tooltip'));
        }
        
        // --- End Tooltip Functions ---

        // --- Retrograde Panel Functions ---

        function handlePlanetClick(e) {
            const clickedPlanet = e.target.closest('.planet');
            if (clickedPlanet && clickedPlanet.parentElement.classList.contains('planets-container') && planetDegrees[clickedPlanet.id]) {
                e.stopPropagation(); // Prevent document click from closing panel immediately

                selectedPlanetForRetrograde = clickedPlanet;
                const planetData = planetDegrees[clickedPlanet.id];
                
                panelPlanetName.textContent = `Planet: ${clickedPlanet.id}`;
                retrogradeCheckbox.checked = planetData.isRetrograde;

                const rect = clickedPlanet.getBoundingClientRect();
                // Position next to the planet, slightly to the right
                retrogradePanel.style.left = `${rect.right + 10}px`;
                retrogradePanel.style.top = `${rect.top}px`;

                // Adjust if it goes off screen to the right
                if (parseFloat(retrogradePanel.style.left) + retrogradePanel.offsetWidth > window.innerWidth) {
                    retrogradePanel.style.left = `${rect.left - retrogradePanel.offsetWidth - 10}px`; // Try to the left
                }
                // Adjust if it goes off screen to the top
                if (parseFloat(retrogradePanel.style.top) < 0) {
                    retrogradePanel.style.top = `5px`;
                }
                // Adjust if it goes off screen to the bottom
                if (parseFloat(retrogradePanel.style.top) + retrogradePanel.offsetHeight > window.innerHeight) {
                    retrogradePanel.style.top = `${window.innerHeight - retrogradePanel.offsetHeight - 5}px`;
                }


                retrogradePanel.classList.add('active');
            } else {
                hideRetrogradePanel();
            }
        }

        function toggleRetrograde() {
            if (selectedPlanetForRetrograde && planetDegrees[selectedPlanetForRetrograde.id]) {
                const isChecked = retrogradeCheckbox.checked;
                planetDegrees[selectedPlanetForRetrograde.id].isRetrograde = isChecked;
                updateRetrogradeSymbol(selectedPlanetForRetrograde);
                // If tooltip is currently showing for this planet, update it
                if (planetTooltip.classList.contains('active') && document.querySelector('.planet.hovered-for-tooltip') === selectedPlanetForRetrograde) {
                    showTooltip(selectedPlanetForRetrograde);
                }
            }
        }

        function updateRetrogradeSymbol(planetElement) {
            let symbolSpan = planetElement.querySelector('.retrograde-symbol');
            if (!symbolSpan) {
                symbolSpan = document.createElement('span');
                symbolSpan.classList.add('retrograde-symbol');
                planetElement.querySelector('.planet-symbol').insertAdjacentElement('afterend', symbolSpan);
            }

            if (planetDegrees[planetElement.id] && planetDegrees[planetElement.id].isRetrograde) {
                symbolSpan.textContent = ' R'; // ' R' for retrograde
                planetElement.classList.add('retrograde');
            } else {
                symbolSpan.textContent = '';
                planetElement.classList.remove('retrograde');
            }
        }

        function hideRetrogradePanel() {
            retrogradePanel.classList.remove('active');
            selectedPlanetForRetrograde = null;
        }

        // Hide retrograde panel if click happens outside of it or a planet
        function handleOutsideClick(e) {
            if (retrogradePanel.classList.contains('active') && 
                !retrogradePanel.contains(e.target) && 
                !e.target.closest('.planet')) {
                hideRetrogradePanel();
            }
        }

        // --- End Retrograde Panel Functions ---


        function getNakshatraAndPada(sign, degree) {
            const nakshatraLengthDegrees = 13.333333333;
            const padaLengthDegrees = nakshatraLengthDegrees / 4;

            const signIndex = signs.indexOf(sign);
            if (signIndex === -1) {
                return { nakshatra: { name: 'N/A' }, pada: '-' };
            }

            const totalDegrees = (signIndex * 30) + degree;

            let nakshatraNumber = Math.floor(totalDegrees / nakshatraLengthDegrees);
            
            if (nakshatraNumber >= nakshatras.length) {
                nakshatraNumber = nakshatras.length - 1;
            }

            const foundNakshatra = nakshatras[nakshatraNumber];
            const degreesIntoCurrentNakshatra = totalDegrees % nakshatraLengthDegrees;
            const pada = Math.floor(degreesIntoCurrentNakshatra / padaLengthDegrees) + 1;

            return {
                nakshatra: foundNakshatra,
                pada: pada
            };
        }

        function updatePlanetDegreeDisplay(planetElement) {
            let degreeDisplay = planetElement.querySelector('.planet-degree-display');
            if (!degreeDisplay) {
                degreeDisplay = document.createElement('span');
                degreeDisplay.classList.add('planet-degree-display');
                planetElement.appendChild(degreeDisplay);
            }

            const planetData = planetDegrees[planetElement.id];
            
            if (planetData) {
                degreeDisplay.textContent = `${planetData.degree.toFixed(2)}°`;
            } else {
                degreeDisplay.textContent = ''; // Clear if planet is in bank
            }
        }

        function resetChart() {
            document.querySelectorAll('.planets-container').forEach(container => {
                Array.from(container.children).forEach(planetEl => {
                    delete planetDegrees[planetEl.id];
                    updatePlanetDegreeDisplay(planetEl);
                    updateRetrogradeSymbol(planetEl); // Clear retrograde symbol on reset
                });
                container.innerHTML = '';
            });
            document.getElementById('planet-bank').innerHTML = initialPlanetBankHTML;
            
            lagnaSign = null;
            resetAllPlanetDegrees();
            hideTooltip();
            hideRetrogradePanel(); // Hide panel on reset
            updateHouseNumbers();
        }

        function resetAllPlanetDegrees() {
            for (const planetId in planetDegrees) {
                delete planetDegrees[planetId];
            }
            document.querySelectorAll('#planet-bank .planet').forEach(planetEl => {
                updatePlanetDegreeDisplay(planetEl);
                updateRetrogradeSymbol(planetEl); // Clear retrograde symbol for planets in bank
            });
        }

        const chartBoxes = document.querySelectorAll('.chart-box[data-sign]');
        function updateHouseNumbers() {
            chartBoxes.forEach(box => {
                const houseLabel = box.querySelector('.house-label');
                if (lagnaSign) {
                    const ascendantIndexInSigns = signs.indexOf(lagnaSign);
                    const signInBox = box.dataset.sign;
                    const signIndexInSigns = signs.indexOf(signInBox);
                    
                    let houseNumber = (signIndexInSigns - ascendantIndexInSigns + 12) % 12 + 1;
                    houseLabel.textContent = `${houseNumber}`;
                } else {
                    houseLabel.textContent = '';
                }
            });
        }
    </script>
</body>
</html>
